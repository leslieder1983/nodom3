{"code":"/**\r\n * css 管理器\r\n * 针对不同的rule，处理方式不同\r\n * CSSStyleRule 进行保存和替换，同时 scopeInModule(模块作用域)有效\r\n * CSSImportRule 路径不重复添加，因为必须加在stylerule前面，所以需要记录最后的import索引号\r\n */\r\nexport class CssManager {\r\n    /**\r\n     * 处理style 元素\r\n     * @param module    模块\r\n     * @param dom       虚拟都没\r\n     * @param root      模块root dom\r\n     * @param add       是否添加\r\n     * @returns         如果是styledom，则返回true，否则返回false\r\n     */\r\n    static handleStyleDom(module, dom, root, add) {\r\n        if (dom.tagName.toLowerCase() !== 'style') {\r\n            return false;\r\n        }\r\n        if (add) {\r\n            root.addClass(this.cssPreName + module.id);\r\n        }\r\n        else {\r\n            root.removeClass(this.cssPreName + module.id);\r\n        }\r\n        return true;\r\n    }\r\n    /**\r\n     * 处理 style 下的文本元素\r\n     * @param module    模块\r\n     * @param dom       style text element\r\n     * @returns         true:style text节点,false:非style text节点\r\n     */\r\n    static handleStyleTextDom(module, dom) {\r\n        if (dom.parent.tagName.toLowerCase() !== 'style') {\r\n            return false;\r\n        }\r\n        //scope=this，在模块根节点添加 限定 class\r\n        CssManager.addRules(module, dom.textContent, dom.parent.getProp('scope') === 'this' ? '.' + this.cssPreName + module.id : undefined);\r\n        return true;\r\n    }\r\n    /**\r\n     * 添加多个css rule\r\n     * @param cssText           rule集合\r\n     * @param module            模块\r\n     * @param scopeName         作用域名(前置选择器)\r\n     */\r\n    static addRules(module, cssText, scopeName) {\r\n        //sheet 初始化\r\n        if (!this.sheet) {\r\n            //safari不支持 cssstylesheet constructor，用 style代替\r\n            let sheet = document.createElement('style');\r\n            document.head.appendChild(sheet);\r\n            this.sheet = document.styleSheets[0];\r\n        }\r\n        //如果有作用域，则清除作用域下的rule\r\n        if (scopeName) {\r\n            this.clearModuleRules(module);\r\n        }\r\n        //是否限定在模块内\r\n        //cssRule 获取正则式  @impot\r\n        const reg = /(@[a-zA-Z]+\\s+url\\(.+?\\))|([.#@a-zA-Z]\\S*(\\s*\\S*\\s*?)?{)|\\}/g;\r\n        //import support url正则式\r\n        const regImp = /@[a-zA-Z]+\\s+url/;\r\n        // keyframe font page support... 开始 位置\r\n        let startIndex = -1;\r\n        // { 个数，遇到 } -1 \r\n        let beginNum = 0;\r\n        let re;\r\n        while ((re = reg.exec(cssText)) !== null) {\r\n            if (regImp.test(re[0])) { //import namespace\r\n                handleImport(re[0]);\r\n            }\r\n            else if (re[0] === '}') { //回收括号，单个样式结束判断\r\n                if (startIndex >= 0 && --beginNum <= 0) { //style @ end\r\n                    let txt = cssText.substring(startIndex, re.index + 1);\r\n                    if (txt[0] === '@') { //@开头\r\n                        this.sheet.insertRule(txt, CssManager.sheet.cssRules ? CssManager.sheet.cssRules.length : 0);\r\n                    }\r\n                    else { //style\r\n                        handleStyle(module, txt, scopeName);\r\n                    }\r\n                    startIndex = -1;\r\n                    beginNum = 0;\r\n                }\r\n            }\r\n            else { //style 或 @内部\r\n                if (startIndex === -1) {\r\n                    startIndex = re.index;\r\n                    beginNum++;\r\n                }\r\n                else {\r\n                    beginNum++;\r\n                }\r\n            }\r\n        }\r\n        /**\r\n         * 处理style rule\r\n         * @param module            模块\r\n         * @param cssText           css 文本\r\n         * @param scopeName         作用域名(前置选择器)\r\n         */\r\n        function handleStyle(module, cssText, scopeName) {\r\n            const reg = /.+(?=\\{)/;\r\n            let r = reg.exec(cssText);\r\n            if (!r) {\r\n                return;\r\n            }\r\n            // 保存样式名，在模块 object manager中以数组存储\r\n            if (scopeName) {\r\n                let arr = module.objectManager.get('$cssRules');\r\n                if (!arr) {\r\n                    arr = [];\r\n                    module.objectManager.set('$cssRules', arr);\r\n                }\r\n                arr.push((scopeName + ' ' + r[0]));\r\n                //为样式添加 scope name\r\n                cssText = scopeName + ' ' + cssText;\r\n            }\r\n            //加入到样式表\r\n            CssManager.sheet.insertRule(cssText, CssManager.sheet.cssRules ? CssManager.sheet.cssRules.length : 0);\r\n        }\r\n        /**\r\n         * 处理import rule\r\n         * @param cssText   css文本\r\n         */\r\n        function handleImport(cssText) {\r\n            const reg = /(?<=\\()\\S+(?=\\))/;\r\n            let r;\r\n            if ((r = reg.exec(cssText)) !== null) {\r\n                if (CssManager.importMap.has(r[0])) {\r\n                    return;\r\n                }\r\n                //插入import rule\r\n                CssManager.sheet.insertRule(cssText, CssManager.importIndex++);\r\n                CssManager.importMap.set(r[0], true);\r\n            }\r\n        }\r\n    }\r\n    /**\r\n     * 清除模块 css rules\r\n     * @param module    模块\r\n     */\r\n    static clearModuleRules(module) {\r\n        let rules = module.objectManager.get('$cssRules');\r\n        if (!rules || rules.length === 0) {\r\n            return;\r\n        }\r\n        //从sheet清除\r\n        for (let i = 0; i < this.sheet.cssRules.length; i++) {\r\n            let r = this.sheet.cssRules[i];\r\n            if (r.selectorText && rules.indexOf(r.selectorText) !== -1) {\r\n                this.sheet.deleteRule(i--);\r\n            }\r\n        }\r\n        //置空cache\r\n        module.objectManager.set('$cssRules', []);\r\n    }\r\n}\r\n/**\r\n * import url map，用于存储import的href路径\r\n */\r\nCssManager.importMap = new Map();\r\n/**\r\n * importrule 位置\r\n */\r\nCssManager.importIndex = 0;\r\n/**\r\n * css class 前置名\r\n */\r\nCssManager.cssPreName = '___nodommodule___';\r\n//# sourceMappingURL=cssmanager.js.map","references":["D:/User_zhao/gitRepository/competition/nodom/core/module.ts","D:/User_zhao/gitRepository/competition/nodom/core/virtualdom.ts"],"map":"{\"version\":3,\"file\":\"cssmanager.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../core/cssmanager.ts\"],\"names\":[],\"mappings\":\"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\"}"}
